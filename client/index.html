<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vidmelt - Video Summarizer</title>
  <link rel="icon" href="data:," />
  <style>body{font-family:Arial,sans-serif;margin:20px;background:#f4f4f4;color:#333}.container{background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);max-width:800px;margin:0 auto}h1{color:#0056b3;text-align:center}.upload-form{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}.upload-form input[type=file]{padding:10px;border:1px solid #ddd;border-radius:4px}.upload-form input[type=submit]{background:#007bff;color:#fff;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;font-size:16px}.upload-form input[type=submit]:hover{background:#0056b3}.status-box{border:1px solid #ccc;padding:15px;border-radius:4px;background:#e9e9e9;min-height:100px;overflow-y:auto}.status-message{margin-bottom:5px;display:flex;align-items:center}.status-message .icon{margin-right:8px;font-size:1.2em}.status-message.error{color:red}.status-message.complete{color:green;font-weight:700}.spinner{border:4px solid rgba(0,0,0,.1);border-left-color:#007bff;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin:10px auto;display:none}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style>
</head>
<body>
  <div class="container">
    <h1>Vidmelt - Video Summarizer</h1>
    <form id="uploadForm" class="upload-form" action="/upload" method="post" enctype="multipart/form-data">
      <input type="file" name="video" accept="video/mp4" required>
      <div class="model-selection">
        <h3>Choose Transcription Model:</h3>
        <label><input type="radio" name="transcription_model" value="whisper-base" checked> Whisper Base (Local)</label>
        <label><input type="radio" name="transcription_model" value="whisper-medium"> Whisper Medium (Local)</label>
        <label><input type="radio" name="transcription_model" value="whisper-large"> Whisper Large (Local)</label>
        <label><input type="radio" name="transcription_model" value="whisper-api"> Whisper-1 (OpenAI API)</label>
      </div>
      <input type="submit" value="Upload and Summarize">
    </form>

    <h2>Or Paste a Link (YouTube/TikTok)</h2>
    <form id="urlForm" class="upload-form">
      <input type="url" id="videoUrl" placeholder="https://www.youtube.com/watch?v=... or https://www.tiktok.com/..." required>
      <div class="model-selection">
        <label><input type="radio" name="url_transcription_model" value="whisper-base" checked> Whisper Base (Local)</label>
        <label><input type="radio" name="url_transcription_model" value="whisper-medium"> Whisper Medium</label>
        <label><input type="radio" name="url_transcription_model" value="whisper-large"> Whisper Large</label>
        <label><input type="radio" name="url_transcription_model" value="whisper-api"> Whisper-1 (OpenAI API)</label>
      </div>
      <input type="submit" value="Fetch and Summarize">
    </form>

    <h2>Processing Status</h2>
    <div id="statusBox" class="status-box"><p>Waiting for video upload...</p></div>
    <div id="loadingSpinner" class="spinner"></div>

    <h2>Your History</h2>
    <div id="history"></div>
    <div style="margin-top:10px;">
      <button id="exportSummaries">Export Selected Summaries</button>
      <button id="exportTranscripts">Export Selected Transcripts</button>
    </div>
  </div>

  <script>
    const statusBox = document.getElementById('statusBox');
    const uploadForm = document.getElementById('uploadForm');
    const urlForm = document.getElementById('urlForm');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const historyDiv = document.getElementById('history');
    const exportSummariesBtn = document.getElementById('exportSummaries');
    const exportTranscriptsBtn = document.getElementById('exportTranscripts');

    function showSpinner(){ loadingSpinner.style.display='block'; }
    function hideSpinner(){ loadingSpinner.style.display='none'; }
    function addStatusMessage(message, icon='', type='info'){
      const p=document.createElement('p');
      p.classList.add('status-message');
      if(type==='error') p.classList.add('error');
      if(type==='complete') p.classList.add('complete');
      p.innerHTML = `<span class="icon">${icon}</span>${message}`;
      statusBox.appendChild(p);
      statusBox.scrollTop = statusBox.scrollHeight;
    }

    uploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      statusBox.innerHTML = '<p>Uploading file...</p>';
      showSpinner();
      const formData = new FormData(uploadForm);
      try {
        const response = await fetch('/upload', { method: 'POST', body: formData });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
      } catch (error) {
        addStatusMessage(`Upload failed: ${error.message}`, '❌', 'error');
        hideSpinner();
      }
    });

    urlForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      statusBox.innerHTML = '<p>Fetching URL...</p>';
      showSpinner();
      const url = document.getElementById('videoUrl').value.trim();
      const model = document.querySelector('input[name="url_transcription_model"]:checked').value;
      try {
        const response = await fetch('/submit_url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, transcription_model: model })
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
      } catch (error) {
        addStatusMessage(`URL submit failed: ${error.message}`, '❌', 'error');
        hideSpinner();
      }
    });

    const eventSource = new EventSource('/stream');
    eventSource.addEventListener('update', function(event) {
      const data = JSON.parse(event.data);
      addStatusMessage(data.message, data.icon || '');
    });
    eventSource.addEventListener('complete', function(event) {
      const data = JSON.parse(event.data);
      addStatusMessage(data.message, data.icon || '✅', 'complete');
      hideSpinner();
      eventSource.close();
      refreshHistory();
    });
    eventSource.addEventListener('error', function(event) {
      try{ const data = JSON.parse(event.data); addStatusMessage(data.message, data.icon || '❌', 'error'); }catch(_){ addStatusMessage('An error occurred', '❌', 'error'); }
      hideSpinner(); eventSource.close();
    });

    async function refreshHistory(){
      try{
        const res = await fetch('/api/history');
        if(!res.ok) throw new Error('failed to load history');
        const items = await res.json();
        historyDiv.innerHTML = '';
        if(!items.length){ historyDiv.innerHTML = '<p>No history yet.</p>'; return; }
        const list = document.createElement('div');
        items.forEach(item => {
          const row = document.createElement('div');
          row.style.marginBottom = '6px';
          row.innerHTML = `
            <label>
              <input type="checkbox" class="hist-cb" value="${item.id}">
              <strong>${item.video_title || item.original_filename}</strong>
              <small>(${item.platform || 'local'})</small>
              - <a href="/summaries/${encodeURIComponent(item.video_title)}.md" target="_blank">summary</a>
              - <a href="/transcripts/${encodeURIComponent(item.video_title)}.txt" target="_blank">transcript</a>
            </label>`;
          list.appendChild(row);
        });
        historyDiv.appendChild(list);
      }catch(e){ historyDiv.innerHTML = `<p style="color:red;">History error: ${e.message}</p>`; }
    }
    function getSelectedIds(){
      return Array.from(document.querySelectorAll('.hist-cb:checked')).map(cb => cb.value).join(',');
    }
    exportSummariesBtn.addEventListener('click',()=>{
      const ids = getSelectedIds(); if(!ids) return alert('Select at least one item');
      window.open(`/export?kind=summary&ids=${encodeURIComponent(ids)}`,'_blank');
    });
    exportTranscriptsBtn.addEventListener('click',()=>{
      const ids = getSelectedIds(); if(!ids) return alert('Select at least one item');
      window.open(`/export?kind=transcript&ids=${encodeURIComponent(ids)}`,'_blank');
    });
    refreshHistory();
  </script>
</body>
</html>
